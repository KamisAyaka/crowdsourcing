# ä¼—åŒ…ä»»åŠ¡åˆçº¦ç³»ç»Ÿ

## ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€å¥—åŸºäºä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦ç³»ç»Ÿï¼Œç”¨äºç®¡ç†ä¼—åŒ…ä»»åŠ¡ã€‚ç³»ç»Ÿæ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹å’Œæ”¯ä»˜æ–¹å¼ï¼Œæä¾›çº çº·è§£å†³æœºåˆ¶ï¼Œç¡®ä¿ä»»åŠ¡åˆ›å»ºè€…å’Œå·¥ä½œè€…ä¹‹é—´çš„å…¬å¹³äº¤æ˜“ã€‚

æœ¬é¡¹ç›®åŸºäº Scaffold-ETH 2 æ„å»ºï¼Œæ˜¯ä¸€ä¸ªå¼€æºã€æœ€æ–°çš„å·¥å…·åŒ…ï¼Œç”¨äºåœ¨ä»¥å¤ªåŠåŒºå—é“¾ä¸Šæ„å»ºå»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åºï¼ˆdappsï¼‰ã€‚å®ƒæ—¨åœ¨è®©å¼€å‘äººå‘˜æ›´å®¹æ˜“åˆ›å»ºå’Œéƒ¨ç½²æ™ºèƒ½åˆçº¦ï¼Œå¹¶æ„å»ºä¸è¿™äº›åˆçº¦äº¤äº’çš„ç”¨æˆ·ç•Œé¢ã€‚

âš™ï¸ æŠ€æœ¯æ ˆï¼šNextJSã€RainbowKitã€Foundryã€Wagmiã€Viem å’Œ Typescript

ä¸»è¦åŠŸèƒ½ï¼š

- âœ… æ™ºèƒ½åˆçº¦çƒ­é‡è½½ï¼šå‰ç«¯ä¼šéšç€æ‚¨ç¼–è¾‘æ™ºèƒ½åˆçº¦è€Œè‡ªåŠ¨é€‚åº”
- ğŸª è‡ªå®šä¹‰ React hooksï¼šå›´ç»• wagmi çš„ React é’©å­é›†åˆï¼Œé€šè¿‡ typescript è‡ªåŠ¨è¡¥å…¨ç®€åŒ–ä¸æ™ºèƒ½åˆçº¦çš„äº¤äº’
- ğŸ§± Web3 ç»„ä»¶åº“ï¼šé€šç”¨ web3 ç»„ä»¶é›†åˆï¼Œå¯å¿«é€Ÿæ„å»ºæ‚¨çš„å‰ç«¯
- ğŸ”¥ ç‡ƒçƒ§é’±åŒ…å’Œæœ¬åœ°æ°´é¾™å¤´ï¼šä½¿ç”¨ç‡ƒçƒ§é’±åŒ…å’Œæœ¬åœ°æ°´é¾™å¤´å¿«é€Ÿæµ‹è¯•æ‚¨çš„åº”ç”¨ç¨‹åº
- ğŸ” é’±åŒ…æä¾›å•†é›†æˆï¼šè¿æ¥ä¸åŒçš„é’±åŒ…æä¾›å•†å¹¶ä¸ä»¥å¤ªåŠç½‘ç»œäº¤äº’

## ç³»ç»Ÿæ¶æ„

### æ¶æ„å›¾

```mermaid
graph TD
    A[TaskTokenä»£å¸åˆçº¦] --> B[BaseTaskåŸºç¡€ä»»åŠ¡åˆçº¦]
    C[DisputeResolverçº çº·è§£å†³åˆçº¦] --> B
    D[UserInfoç”¨æˆ·ä¿¡æ¯åˆçº¦] --> B
    B --> E[FixedPaymentTaskå›ºå®šæ”¯ä»˜ä»»åŠ¡]
    B --> F[BiddingTaskç«æ ‡ä»»åŠ¡]
    B --> G[MilestonePaymentTaské‡Œç¨‹ç¢‘æ”¯ä»˜ä»»åŠ¡]

    H[ä»»åŠ¡åˆ›å»ºè€…] -->|åˆ›å»ºä»»åŠ¡/æ”¯ä»˜æŠ¥é…¬| B
    I[å·¥ä½œè€…] -->|ç«æ ‡/æäº¤å·¥ä½œ| B
    J[ç®¡ç†å‘˜] -->|å¤„ç†çº çº·| C



    style A fill:#FFE4C4,stroke:#333
    style B fill:#98FB98,stroke:#333
    style C fill:#98FB98,stroke:#333
    style D fill:#98FB98,stroke:#333
    style E fill:#87CEEB,stroke:#333
    style F fill:#87CEEB,stroke:#333
    style G fill:#87CEEB,stroke:#333
```

### æ ¸å¿ƒåˆçº¦ä¸ä»»åŠ¡ç±»å‹

æœ¬ç³»ç»Ÿæ ¸å¿ƒåˆçº¦åˆ†ä¸ºåŸºç¡€åˆçº¦å’Œä»»åŠ¡ç±»å‹åˆçº¦ï¼ŒååŒå®ç°ä¼—åŒ…ä»»åŠ¡çš„å®Œæ•´æµç¨‹ä¸å®‰å…¨ä¿éšœï¼š

- **BaseTask.solï¼ˆåŸºç¡€ä»»åŠ¡åˆçº¦ï¼‰**ï¼šæ‰€æœ‰ä»»åŠ¡ç±»å‹çš„åŸºç±»ï¼Œç»Ÿä¸€ä»»åŠ¡ç»“æ„å’Œé€šç”¨åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»»åŠ¡çŠ¶æ€ç®¡ç†ã€å¹³å°è´¹ç”¨ç»“ç®—ã€çº çº·æœºåˆ¶é›†æˆå’ŒæŠ½è±¡æ–¹æ³•å®šä¹‰ã€‚
- **TaskToken.solï¼ˆä»»åŠ¡ä»£å¸åˆçº¦ï¼‰**ï¼šå¹³å° ERC20 ä»£å¸ï¼Œæ”¯æŒé“¸é€ ã€é”€æ¯ã€æˆæƒï¼Œä½œä¸ºä»»åŠ¡å¥–åŠ±æ”¯ä»˜å’Œç®¡ç†å‘˜è´¨æŠ¼ã€‚
- **DisputeResolver.solï¼ˆçº çº·è§£å†³åˆçº¦ï¼‰**ï¼šå¤„ç†ä»»åŠ¡çº çº·ï¼Œç®¡ç†å‘˜è´¨æŠ¼æŠ•ç¥¨ï¼Œèµ„é‡‘æ‰˜ç®¡ä¸åˆ†é…ï¼Œä¿éšœäº¤æ˜“å…¬å¹³ã€‚
- **UserInfo.solï¼ˆç”¨æˆ·ä¿¡æ¯åˆçº¦ï¼‰**ï¼šç®¡ç†ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ä¸ç›¸åº”çš„æŠ€èƒ½ã€‚

#### ä»»åŠ¡ç±»å‹åˆçº¦

- **FixedPaymentTask.solï¼ˆå›ºå®šæ”¯ä»˜ä»»åŠ¡ï¼‰**ï¼šä¸€å¯¹ä¸€ç»“ç®—ï¼Œå·¥ä½œè€…æäº¤å·¥ä½œé‡è¯æ˜ï¼Œä»»åŠ¡åˆ›å»ºè€…éªŒè¯åä¸€æ¬¡æ€§æ”¯ä»˜å…¨éƒ¨æŠ¥é…¬ã€‚
- **BiddingTask.solï¼ˆç«æ ‡ä»»åŠ¡ï¼‰**ï¼šæ”¯æŒå¤šå·¥ä½œè€…ç«æ ‡ï¼Œä»»åŠ¡åˆ›å»ºè€…é€‰æ‹©æœ€ä¼˜æŠ¥ä»·ï¼Œå·¥ä½œå®Œæˆåæ”¯ä»˜æŠ¥é…¬ã€‚
- **MilestonePaymentTask.solï¼ˆé‡Œç¨‹ç¢‘æ”¯ä»˜ä»»åŠ¡ï¼‰**ï¼šä»»åŠ¡åˆ†é˜¶æ®µè¿›è¡Œï¼Œæ¯ä¸ªé‡Œç¨‹ç¢‘ç‹¬ç«‹æè¿°å’ŒæŠ¥é…¬ï¼ŒæŒ‰è¿›åº¦é€æ­¥ç»“ç®—ã€‚

### ä¸»è¦åŠŸèƒ½ç‰¹æ€§

- **ä»»åŠ¡å…¨æµç¨‹ç®¡ç†**ï¼šä»»åŠ¡åˆ›å»ºã€å–æ¶ˆã€å»¶æœŸã€å¥–åŠ±è°ƒæ•´ï¼Œå·¥ä½œè€…åˆ†é…ï¼Œå·¥ä½œé‡è¯æ˜æäº¤ä¸éªŒè¯ï¼Œå®æ—¶çŠ¶æ€è·Ÿè¸ªã€‚
- **å¤šæ ·åŒ–é›‡ä½£æœºåˆ¶**ï¼šå¹³å°è‡ªåŠ¨æ‰£é™¤è´¹ç”¨ï¼ˆé»˜è®¤ 1%ï¼Œå¯è°ƒæ•´ï¼‰ï¼Œæ”¯æŒå›ºå®šã€ç«æ ‡ã€é‡Œç¨‹ç¢‘ä¸‰ç§æ–¹å¼ï¼Œèµ„é‡‘æ‰˜ç®¡ç¡®ä¿å®‰å…¨ã€‚
- **çº çº·è§£å†³ä¸æŠ•ç¥¨åˆ†é…**ï¼šçº çº·æäº¤åèµ„é‡‘æ‰˜ç®¡ï¼Œç®¡ç†å‘˜è´¨æŠ¼ä»£å¸å‚ä¸æŠ•ç¥¨ï¼Œå…¬å¹³åˆ†é…èµ„é‡‘å¹¶å¥–åŠ±è¯„åˆ¤è€…ã€‚
- **å®‰å…¨ä¸æƒé™æ§åˆ¶**ï¼šé˜²é‡å…¥æ”»å‡»ã€åˆçº¦æš‚åœä¸æ¢å¤ã€ä¸¥æ ¼è§’è‰²æƒé™ã€æ—¶é—´é”é˜²æ­¢æ¶æ„çº çº·ã€‚

## ä½¿ç”¨æµç¨‹

### å›ºå®šæ”¯ä»˜ä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant C as ä»»åŠ¡åˆ›å»ºè€…
    participant T as FixedPaymentTaskåˆçº¦
    participant W as å·¥ä½œè€…

    C->>T: åˆ›å»ºä»»åŠ¡
    C->>T: æ·»åŠ å·¥ä½œè€…å¹¶å­˜å…¥æŠ¥é…¬
    T->>T: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­
    W->>T: æäº¤å·¥ä½œé‡è¯æ˜
    C->>T: éªŒè¯å·¥ä½œé‡è¯æ˜
    T->>T: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ
    W->>T: é¢†å–æŠ¥é…¬
    T->>T: æ‰£é™¤1%å¹³å°è´¹ç”¨å¹¶è½¬è´¦ç»™å·¥ä½œè€…
```

### ç«æ ‡ä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant C as ä»»åŠ¡åˆ›å»ºè€…
    participant T as BiddingTaskåˆçº¦
    participant W1 as å·¥ä½œè€…1
    participant W2 as å·¥ä½œè€…2

    C->>T: åˆ›å»ºä»»åŠ¡
    W1->>T: æäº¤ç«æ ‡ï¼ˆé‡‘é¢+é¢„è®¡æ—¶é—´ï¼‰
    W2->>T: æäº¤ç«æ ‡ï¼ˆé‡‘é¢+é¢„è®¡æ—¶é—´ï¼‰
    C->>T: é€‰æ‹©æœ€ä¼˜ç«æ ‡å¹¶æ¥å—
    T->>T: è½¬ç§»æŠ¥é…¬åˆ°åˆçº¦å¹¶æ›´æ–°çŠ¶æ€
    W->>T: å®Œæˆä»»åŠ¡å¹¶æäº¤å·¥ä½œé‡è¯æ˜
    C->>T: éªŒè¯å·¥ä½œé‡è¯æ˜
    T->>T: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ
    W->>T: é¢†å–æŠ¥é…¬
    T->>T: æ‰£é™¤1%å¹³å°è´¹ç”¨å¹¶è½¬è´¦ç»™å·¥ä½œè€…
```

### é‡Œç¨‹ç¢‘æ”¯ä»˜ä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant C as ä»»åŠ¡åˆ›å»ºè€…
    participant T as MilestonePaymentTaskåˆçº¦
    participant W as å·¥ä½œè€…

    C->>T: åˆ›å»ºä»»åŠ¡å¹¶å®šä¹‰é‡Œç¨‹ç¢‘
    C->>T: æ·»åŠ å·¥ä½œè€…
    T->>T: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­
    W->>T: å®Œæˆé‡Œç¨‹ç¢‘å¹¶æäº¤å·¥ä½œé‡è¯æ˜
    C->>T: éªŒè¯å·¥ä½œé‡è¯æ˜
    T->>T: æ›´æ–°é‡Œç¨‹ç¢‘çŠ¶æ€å¹¶æ”¯ä»˜å¯¹åº”æŠ¥é…¬
    T->>T: æ‰£é™¤1%å¹³å°è´¹ç”¨å¹¶è½¬è´¦ç»™å·¥ä½œè€…
    W->>T: å®Œæˆæ‰€æœ‰é‡Œç¨‹ç¢‘
    T->>T: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ
```

### çº çº·å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant P as å½“äº‹äºº
    participant T as ä»»åŠ¡åˆçº¦
    participant D as çº çº·è§£å†³åˆçº¦
    participant A as ç®¡ç†å‘˜
    participant V as æŠ•ç¥¨è€…

    P->>T: æäº¤çº çº·
    T->>D: è½¬ç§»èµ„é‡‘å¹¶åˆ›å»ºçº çº·è®°å½•
    A->>D: è´¨æŠ¼1000ä¸ªä»£å¸æˆä¸ºè¯„åˆ¤è€…
    V->>D: å¯¹çº çº·è¿›è¡ŒæŠ•ç¥¨
    D->>D: å¤„ç†æŠ•ç¥¨å¹¶è®¡ç®—åˆ†é…æ–¹æ¡ˆ
    alt æ–¹æ¡ˆè¢«æ¥å—
        P->>D: åŒæ–¹ç¡®è®¤åˆ†é…æ–¹æ¡ˆ
        D->>D: æŒ‰æ–¹æ¡ˆåˆ†é…èµ„é‡‘ç»™å„æ–¹
        D->>D: åˆ†é…0.5%å¥–åŠ±ç»™è¯„åˆ¤è€…
    else æ–¹æ¡ˆè¢«æ‹’ç»
        P->>D: ä»»ä¸€æ–¹æ‹’ç»åˆ†é…æ–¹æ¡ˆ
        D->>D: æ”¶å–æ‹’ç»è´¹ç”¨å¹¶åˆ†é…ç»™è¯„åˆ¤è€…
        D->>D: é‡æ–°è¿›å…¥æŠ•ç¥¨çŠ¶æ€
        V->>D: é‡æ–°æŠ•ç¥¨
    end
```

## å¼€å‘ç¯å¢ƒè¦æ±‚

å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦å®‰è£…ä»¥ä¸‹å·¥å…·ï¼š

- Node.js (>= v20.18.3)
- Yarn (v1 æˆ– v2+)
- Git

## å¿«é€Ÿå¼€å§‹

è¦å¼€å§‹ä½¿ç”¨æœ¬é¡¹ç›®ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. å¦‚æœåœ¨ CLI ä¸­è·³è¿‡äº†ä¾èµ–å®‰è£…ï¼Œè¯·å…ˆå®‰è£…ä¾èµ–ï¼š

```bash
cd crowdsourcing
yarn install
```

2. åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œæœ¬åœ°ç½‘ç»œï¼š

```bash
yarn chain
```

è¯¥å‘½ä»¤ä½¿ç”¨ Foundry å¯åŠ¨æœ¬åœ°ä»¥å¤ªåŠç½‘ç»œã€‚ç½‘ç»œåœ¨æ‚¨çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œï¼Œå¯ç”¨äºæµ‹è¯•å’Œå¼€å‘ã€‚æ‚¨å¯ä»¥åœ¨ `packages/foundry/foundry.toml` ä¸­è‡ªå®šä¹‰ç½‘ç»œé…ç½®ã€‚

3. åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­éƒ¨ç½²æµ‹è¯•åˆçº¦ï¼š

```bash
yarn deploy
```

è¯¥å‘½ä»¤å°†æµ‹è¯•æ™ºèƒ½åˆçº¦éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œã€‚åˆçº¦ä½äº `packages/foundry/contracts`ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚`yarn deploy` å‘½ä»¤ä½¿ç”¨ä½äº `packages/foundry/script` ä¸­çš„éƒ¨ç½²è„šæœ¬æ¥å°†åˆçº¦éƒ¨ç½²åˆ°ç½‘ç»œã€‚æ‚¨ä¹Ÿå¯ä»¥è‡ªå®šä¹‰éƒ¨ç½²è„šæœ¬ã€‚

4. åœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ä¸­å¯åŠ¨ NextJS åº”ç”¨ï¼š

```bash
yarn start
```

åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ‚¨çš„åº”ç”¨ï¼š`http://localhost:3000`ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `Debug Contracts` é¡µé¢ä¸æ‚¨çš„æ™ºèƒ½åˆçº¦è¿›è¡Œäº¤äº’ã€‚æ‚¨å¯ä»¥åœ¨ `packages/nextjs/scaffold.config.ts` ä¸­è°ƒæ•´åº”ç”¨é…ç½®ã€‚

è¿è¡Œæ™ºèƒ½åˆçº¦æµ‹è¯•ï¼š

```bash
yarn foundry:test
```

- åœ¨ `packages/foundry/contracts` ä¸­ç¼–è¾‘æ‚¨çš„æ™ºèƒ½åˆçº¦
- åœ¨ `packages/nextjs/app/page.tsx` ä¸­ç¼–è¾‘æ‚¨çš„å‰ç«¯ä¸»é¡µã€‚æœ‰å…³ [è·¯ç”±](https://nextjs.org/docs/app/building-your-application/routing/defining-routes) å’Œé…ç½® [é¡µé¢/å¸ƒå±€](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts) çš„æŒ‡å¯¼ï¼Œè¯·æŸ¥çœ‹ Next.js æ–‡æ¡£
- åœ¨ `packages/foundry/script` ä¸­ç¼–è¾‘æ‚¨çš„éƒ¨ç½²è„šæœ¬

## åˆçº¦ä¾èµ–

æœ¬ç³»ç»Ÿä¾èµ–äº OpenZeppelin åˆçº¦åº“ï¼ŒåŒ…æ‹¬ï¼š

- ReentrancyGuardï¼šé˜²é‡å…¥ä¿æŠ¤
- Pausableï¼šåˆçº¦æš‚åœåŠŸèƒ½
- Ownableï¼šæ‰€æœ‰æƒç®¡ç†
- ERC20ï¼šä»£å¸æ ‡å‡†å®ç°
- SafeERC20ï¼šå®‰å…¨çš„ ERC20 æ“ä½œ

## éƒ¨ç½²è¯´æ˜

åˆçº¦éƒ¨ç½²éœ€è¦æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š

1. éƒ¨ç½² TaskToken åˆçº¦
2. éƒ¨ç½² DisputeResolver åˆçº¦
3. éƒ¨ç½² UserInfo åˆçº¦
4. éƒ¨ç½²å…·ä½“ä»»åŠ¡ç±»å‹åˆçº¦ï¼ˆå¦‚ FixedPaymentTaskã€BiddingTaskã€MilestonePaymentTaskï¼‰

## æµ‹è¯•è¯´æ˜

é¡¹ç›®åŒ…å«å…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿åˆçº¦åŠŸèƒ½æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ï¼š

```
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
yarn foundry:test

# è¿è¡Œç‰¹å®šåˆçº¦æµ‹è¯•
forge test --match-contract FixedPaymentTaskTest

# è¿è¡Œå¸¦è¯¦ç»†è¾“å‡ºçš„æµ‹è¯•
forge test -vvv

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
forge coverage
```

æµ‹è¯•æ–‡ä»¶ä½äº `packages/foundry/test/` ç›®å½•ä¸‹ï¼Œæ¯ä¸ªä¸»è¦åˆçº¦éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ï¼š

- `TaskToken.t.sol` - ä»£å¸åˆçº¦æµ‹è¯•
- `DisputeResolver.t.sol` - çº çº·è§£å†³åˆçº¦æµ‹è¯•
- `FixedPaymentTask.t.sol` - å›ºå®šæ”¯ä»˜ä»»åŠ¡æµ‹è¯•
- `BiddingTask.t.sol` - ç«æ ‡ä»»åŠ¡æµ‹è¯•
- `MilestonePaymentTask.t.sol` - é‡Œç¨‹ç¢‘æ”¯ä»˜ä»»åŠ¡æµ‹è¯•
