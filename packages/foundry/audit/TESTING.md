# 合约测试指南

## 概述

本项目使用 Foundry 测试框架进行智能合约测试。测试文件位于 `test/` 目录下，每个合约都有对应的测试文件。

## 测试环境设置

在运行测试之前，确保已经安装了 Foundry 工具链。如果尚未安装，请参考 Scaffold-ETH 2 文档进行安装。

## 测试结构

测试按照合约依赖关系进行组织：

1. `TaskToken.t.sol` - TaskToken 合约测试（基础代币合约）
2. `DisputeResolver.t.sol` - DisputeResolver 合约测试（纠纷解决机制）
3. `FixedPaymentTask.t.sol` - FixedPaymentTask 合约测试（固定支付任务）
4. `BiddingTask.t.sol` - BiddingTask 合约测试（竞标任务）
5. `MilestonePaymentTask.t.sol` - MilestonePaymentTask 合约测试（里程碑支付任务）

## 运行测试

### 运行所有测试

```bash
cd packages/foundry
forge test
```

### 运行特定合约的测试

```bash
# 运行 TaskToken 合约测试
forge test --match-contract TaskTokenTest

# 运行 DisputeResolver 合约测试
forge test --match-contract DisputeResolverTest

# 运行 FixedPaymentTask 合约测试
forge test --match-contract FixedPaymentTaskTest

# 运行 BiddingTask 合约测试
forge test --match-contract BiddingTaskTest

# 运行 MilestonePaymentTask 合约测试
forge test --match-contract MilestonePaymentTaskTest
```

### 运行带有详细输出的测试

```bash
# 运行测试并显示详细输出
forge test -vvv

# 运行特定测试并显示详细输出
forge test --match-test testCreateTask -vvv
```

## 测试内容

### TaskToken 合约测试

测试包括：
- 合约部署
- 代币铸造（仅所有者）
- 代币销毁
- 授权任务合约使用代币
- 权限控制测试（只有所有者可以铸造代币）

### DisputeResolver 合约测试

测试包括：
- 合约部署
- 管理员质押成为管理员
- 管理员提取质押
- 提交纠纷
- 管理员投票
- 处理投票结果
- 批准提案
- 拒绝提案
- 分配资金
- 异常情况处理（重复质押、非管理员提取、无效参数等）
- 权限控制测试

### FixedPaymentTask 合约测试

测试包括：
- 合约部署
- 创建任务
- 添加工作者
- 提交工作量证明
- 验证工作量证明
- 支付任务
- 终止任务
- 提交纠纷
- 权限控制测试
- 异常情况处理
- 时间相关测试（截止时间、纠纷提交时间等）

具体测试用例：
- 合约部署测试
- 创建任务及参数验证
- 添加工作者及权限控制
- 工作量证明提交与验证
- 任务支付与资金分配
- 任务终止与资金退还
- 纠纷提交及时间限制
- 各种异常情况处理（无效地址、状态检查、权限控制等）

### BiddingTask 合约测试

测试包括：
- 合约部署
- 创建任务
- 提交竞标
- 接受竞标
- 提交工作量证明
- 验证工作量证明
- 支付任务
- 终止任务
- 提交纠纷
- 权限控制测试
- 异常情况处理
- 时间相关测试（截止时间、纠纷提交时间等）

具体测试用例：
- 合约部署测试
- 创建任务及参数验证
- 提交竞标及竞标验证
- 接受竞标及任务状态更新
- 工作量证明提交与验证
- 任务支付与资金分配
- 任务终止与资金退还
- 纠纷提交及时间限制
- 各种异常情况处理（无效地址、状态检查、权限控制等）
- 竞标截止时间验证
- 竞标金额和描述验证
- 任务状态转换验证

### MilestonePaymentTask 合约测试

测试包括：
- 合约部署
- 创建任务
- 添加工作者
- 添加里程碑
- 提交里程碑工作量证明
- 验证里程碑工作量证明
- 支付里程碑
- 完成任务
- 终止任务
- 提交纠纷
- 权限控制测试
- 异常情况处理
- 时间相关测试（截止时间、纠纷提交时间等）

具体测试用例：
- 合约部署测试
- 创建任务及参数验证
- 添加工作者及权限控制
- 添加里程碑及奖励验证
- 提交里程碑工作量证明
- 验证里程碑工作量证明
- 支付里程碑与资金分配
- 完成任务与状态更新
- 任务终止与资金退还
- 纠纷提交及时间限制
- 各种异常情况处理（无效地址、状态检查、权限控制等）
- 里程碑索引验证
- 里程碑状态验证
- 工作者权限验证

## 编写新测试

编写新测试时，请遵循以下规范：

1. 为每个合约创建独立的测试文件
2. 测试文件名应与合约名对应，如 `合约名.t.sol`
3. 使用清晰的测试函数名，采用 `test` 前缀
4. 为异常情况编写测试，使用 `vm.expectRevert()` 验证预期的回滚
5. 使用 `setUp()` 函数进行测试环境初始化
6. 为复杂测试场景添加注释说明
7. 测试应覆盖所有主要功能和边界条件
8. 包含权限控制和安全相关测试

## 测试覆盖率

建议使用以下命令检查测试覆盖率：

```bash
forge coverage
```

这将生成测试覆盖率报告，帮助识别未被测试覆盖的代码部分。

## 最佳实践

1. **测试顺序**：按照合约依赖关系顺序编写测试，先测试基础合约
2. **边界条件**：测试各种边界条件和异常情况
3. **权限控制**：验证所有权限控制机制是否正常工作
4. **状态转换**：验证合约状态在各种操作下的正确转换
5. **事件触发**：验证重要操作是否正确触发相应事件
6. **资金流转**：验证所有资金流转是否正确执行
7. **时间相关测试**：使用 `vm.warp()` 控制区块时间戳进行时间相关测试
8. **完整业务流程**：测试完整的业务流程，确保各环节正确衔接